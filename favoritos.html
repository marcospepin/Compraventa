<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Favoritos - MCR Motors</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
</head>
<body>
  <header class="sticky-top">
    <div class="top-bar bg-dark text-white py-2">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="contact-info">
              <span class="me-3"><i class="fas fa-phone-alt me-2"></i>617 540 616</span>
              <span><i class="fas fa-map-marker-alt me-2"></i>San CipriÃ¡n De ViÃ±as, Galicia</span>
            </div>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="social-links">
              <a href="https://www.instagram.com/marcos_pepin/" target="_blank" class="text-white me-3"><i class="fab fa-instagram"></i></a>
              <a href="https://es.wallapop.com/user/pepinairlines-354840890" target="_blank" class="text-white me-3"><i class="fas fa-store"></i></a>
              <a href="https://www.coches.net/concesionario/grmmotorsport/" target="_blank" class="text-white"><i class="fas fa-car"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <img src="images/logo-ppal.png" alt="MCR Motors Logo" height="60">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Inicio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="coches-venta.html">Coches en Venta</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="coches-vendidos.html">Coches Vendidos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="financiacion.html">FinanciaciÃ³n</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contacto.html">Contacto</a>
            </li>
          </ul>
          <div class="ms-lg-3 mt-3 mt-lg-0" id="auth-buttons">
            <a href="login.html" class="btn btn-outline-primary me-2"><i class="fas fa-sign-in-alt me-1"></i>Iniciar SesiÃ³n</a>
            <a href="registro.html" class="btn btn-primary"><i class="fas fa-user-plus me-1"></i>Registrarse</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <section class="page-header bg-dark text-white py-5">
      <div class="container">
        <div class="row">
          <div class="col-12 text-center">
            <h1><i class="fas fa-heart me-2"></i>Mis Favoritos</h1>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item"><a href="index.html" class="text-white">Inicio</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">Favoritos</li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
    </section>

    <section class="favorites-section py-5">
      <div class="container">
        <div class="row mb-4">
          <div class="col-12">
            <h2>VehÃ­culos Guardados</h2>
            <p class="text-muted" id="favorites-count">Cargando...</p>
          </div>
        </div>
        
        <div class="row g-4" id="favorites-container">
          <!-- Los favoritos se cargarÃ¡n dinÃ¡micamente aquÃ­ -->
        </div>
      </div>
    </section>
  </main>

  <footer class="footer bg-dark text-white py-5 mt-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <img src="images/logo-ppal.png" alt="MCR Motors Logo" height="60" class="mb-3">
          <p>Tu concesionario de confianza especializado en vehÃ­culos premium y de alta gama.</p>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>Contacto</h5>
          <ul class="list-unstyled">
            <li><i class="fas fa-phone-alt me-2"></i>617 540 616</li>
            <li><i class="fas fa-map-marker-alt me-2"></i>San CipriÃ¡n De ViÃ±as, Galicia</li>
          </ul>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>SÃ­guenos</h5>
          <div class="social-links">
            <a href="https://www.instagram.com/marcos_pepin/" target="_blank" class="text-white me-3 fs-4"><i class="fab fa-instagram"></i></a>
            <a href="https://es.wallapop.com/user/pepinairlines-354840890" target="_blank" class="text-white me-3 fs-4"><i class="fas fa-store"></i></a>
            <a href="https://www.coches.net/concesionario/grmmotorsport/" target="_blank" class="text-white fs-4"><i class="fas fa-car"></i></a>
          </div>
        </div>
      </div>
      <hr class="my-4 bg-white">
      <div class="row">
        <div class="col-12 text-center">
          <p class="mb-0">&copy; 2025 MCR Motors. Todos los derechos reservados.</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/script.js"></script>
  <script>
    let currentUser = null;

    // Verificar sesiÃ³n
    async function checkSession() {
      try {
        const response = await fetch('php/auth.php?action=check_session');
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }
        
        currentUser = data.user;
        loadFavorites();
      } catch (error) {
        console.error('Error:', error);
        window.location.href = 'login.html';
      }
    }

    // Cargar favoritos
    async function loadFavorites() {
      const container = document.getElementById('favorites-container');
      const countElement = document.getElementById('favorites-count');
      
      container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"></div></div>';
      
      try {
        const response = await fetch('php/favoritos.php?action=list');
        const data = await response.json();
        
        if (data.success) {
          const favorites = data.favoritos;
          
          if (favorites.length === 0) {
            container.innerHTML = `
              <div class="col-12 text-center py-5">
                <i class="fas fa-heart-broken fa-4x text-muted mb-3"></i>
                <h3>No tienes favoritos aÃºn</h3>
                <p class="text-muted">Explora nuestro catÃ¡logo y guarda tus vehÃ­culos favoritos</p>
                <a href="coches-venta.html" class="btn btn-primary mt-3">Ver CatÃ¡logo</a>
              </div>
            `;
            countElement.textContent = 'No hay favoritos guardados';
            return;
          }
          
          countElement.textContent = `${favorites.length} vehÃ­culo${favorites.length !== 1 ? 's' : ''} guardado${favorites.length !== 1 ? 's' : ''}`;
          renderFavorites(favorites);
        }
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="col-12 text-center py-5"><p class="text-danger">Error al cargar favoritos</p></div>';
      }
    }

    // Renderizar favoritos
    function renderFavorites(favorites) {
      const container = document.getElementById('favorites-container');
      container.innerHTML = '';
      
      favorites.forEach(vehicle => {
        const card = createFavoriteCard(vehicle);
        container.innerHTML += card;
      });
      
      // Agregar event listeners
      document.querySelectorAll('.btn-remove-favorite').forEach(btn => {
        btn.addEventListener('click', removeFavorite);
      });
    }

    // Crear tarjeta de favorito
    function createFavoriteCard(vehicle) {
      const imageUrl = vehicle.imagen_url || 'https://via.placeholder.com/800x500?text=Sin+Imagen';
      const precio = parseFloat(vehicle.precio).toLocaleString('es-ES', { minimumFractionDigits: 2 });
      const kilometraje = vehicle.kilometraje ? parseInt(vehicle.kilometraje).toLocaleString('es-ES') : 'N/D';
      
      return `
        <div class="col-md-6 col-lg-4">
          <div class="card car-card h-100">
            <div class="car-image-wrapper position-relative">
              <img src="${imageUrl}" class="card-img-top" alt="${vehicle.marca} ${vehicle.modelo}" onerror="this.src='https://via.placeholder.com/800x500?text=Sin+Imagen'">
              <span class="car-price">${precio} â‚¬</span>
              <button class="btn btn-favorito btn-remove-favorite" data-vehicle-id="${vehicle.id}" title="Quitar de favoritos">
                <i class="fas fa-heart"></i>
              </button>
            </div>
            <div class="card-body">
              <h5 class="card-title">${vehicle.marca} ${vehicle.modelo}</h5>
              <p class="card-text text-muted">${vehicle.anio} | ${kilometraje} km | ${vehicle.combustible}</p>
              <p class="text-muted small"><i class="fas fa-calendar-plus me-2"></i>Guardado: ${new Date(vehicle.fecha_agregado).toLocaleDateString('es-ES')}</p>
            </div>
            <div class="card-footer bg-white border-top-0">
              <div class="d-flex justify-content-between">
                <a href="#" class="btn btn-outline-primary btn-sm">Ver Detalles</a>
                <a href="contacto.html" class="btn btn-primary btn-sm">Contactar</a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Eliminar favorito
    async function removeFavorite(e) {
      e.preventDefault();
      const btn = e.currentTarget;
      const vehicleId = btn.dataset.vehicleId;
      
      if (!confirm('Â¿Quitar este vehÃ­culo de favoritos?')) return;
      
      try {
        const response = await fetch('php/favoritos.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'remove', vehiculo_id: vehicleId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          loadFavorites();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', checkSession);
  </script>
</body>
</html>

